<?php
session_start(); // Inicia la sesión PHP

$departmentId = isset($_SESSION['departmentId']) ? $_SESSION['departmentId'] : '';
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Clinica-Optica</title>
    <!-- ======== Styles ========== Direccion de la carpeta-->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* Estilo para el iframe */
        #miIframePacientes {
            border: none; /* Quita el borde del iframe */
            overflow: hidden; /* Deshabilita el desplazamiento */
        }
    </style>

    <!-- Estilos para la modal de cerrar sesion -->
    <style>
         @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');
        /* Estilos para la ventana modal */
        .modal {
            font-family: 'Ubuntu', sans-serif;
            display: none;
            position: fixed;
            padding-top: 110px;
            padding-left: 115px;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            font-display: flex ;
            background-color: rgba(0, 0, 0, 0.4);
        }
    
        .modal-content {
            border-radius: 15px;
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            animation-name: modalopen;
            animation-duration: 0.4s;
            text-align: center;
            font-size: 25px;
        }
    
        @keyframes modalopen {
            from {opacity: 0}
            to {opacity: 1}
        }
    
        /* Estilos para el botón de cierre */
        .closee {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
    
        .closee:hover,
        .closee:focus {
            color: red;
            text-decoration: none;
            cursor: pointer;
        }

        button[name="btnCerrarSesion"] {
        /* Estilos para el botón de cerrar sesión */
        border: none;
        background-color: #512da8;/* Cambia el color de fondo */
        color: white; /* Cambia el color del texto */
        border-radius: 15px; /* Elimina el borde */
        padding: 10px 20px; /* Ajusta el relleno */
        font-size: 16px; /* Ajusta el tamaño de fuente */
        cursor: pointer;
        display: block; /* Cambia el display a bloque para que pueda centrarse */
        margin: auto;
        margin-top: 25px;  
        }

        button[name="btnCerrarSesion"]:hover {
        /* Estilos cuando el cursor pasa sobre el botón */
        background-color: #f44336; /* Cambia el color de fondo */
        }
    </style>


<!-- ====================== MODAL DE USUARIO, CONNSULTAR SU INFO =========================== -->
    <style>
  .modall {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modall-content {
    background-color: #fff;
    border-radius: 6px;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    max-width: 1000px;
    width: 80%;
    margin: auto;
    padding: 40px;
    position: absolute;
    left: 55%;
    top: 50%;
    transform: translate(-50%, -50%);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: red;
    text-decoration: none;
    cursor: pointer;
}

.container header {
    margin-top: 0;
    font-size: 20px;
    font-weight: 600;
    color: #333;
    position: relative;
}

.container header::before {
    content: "";
    position: absolute;
    left: 0;
    bottom: -5px;
    height: 3px;
    width: 27px;
    border-radius: 8px;
    background-color: #4070f4;
}

.container form {
    margin-top: 10px;
    height: 505px;
    background-color: #fff;
}

.container form .title {
    margin-top: 10px;
    display: block;
    margin-bottom: 20px;
    font-size: 16px;
    color: #4070f4;
}

.container form .fields {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    
}

.form .fields .input-field {
    display: flex;
    width: calc(100% / 3 - 15px);
    flex-direction: column;
    margin: 4px 0;
}

.input-field label {
    font-size: 17px;
    font-weight: 300;
    color: #2e2e2e;
}

.input-field input,
.input-field select {
    outline: none;
    font-size: 14px;
    font-weight: 400;
    color: #333;
    border-radius: 5px;
    border: 1px solid #aaa;
    padding: 0 15px;
    height: 42px;
    margin: 8px 0;
}

.input-field input:is(:focus, :valid) {
    box-shadow: 0 3px 6px rgba(45, 13, 255, 0.13);
}

.input-field input[type="date"] {
    color: #707070;
}

.input-field input[type="date"]:valid {
    color: #333;
}

.container form button {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 45px;
    max-width: 200px;
    width: 100%;
    border: none;
    outline: none;
    color: #fff;
    border-radius: 5px;
    margin: 25px 0;
    background-color: #4070f4;
    transition: all 0.3s linear;
    cursor: pointer;
    font-size: 20px;
}

form button:hover {
    background-color: #265df2;
}

form button i {
    margin: 0 6px;
}
</style>

<!-- ====================== MODAL DE ALERTA =========================== -->
<style>
   .modalll {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modalll-content {
    background-color: #fff;
    border-radius: 6px;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    max-width: 1000px;
    width: 80%;
    margin: auto;
    padding: 40px;
    position: absolute;
    left: 55%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex; /* Usar flexbox */
    justify-content: center; /* Centrar horizontalmente */
    align-items: center; /* Centrar verticalmente */
    flex-direction: column; /* Alinear los elementos en columna */
    /* max-height: 70%; Reducir la altura máxima */
    height: 220px; /* Restaurar la altura automática */
}

.close {
    color: #aaa;
    position: absolute; /* Cambiado a posición absoluta */
    top: 10px; /* Ajustado para moverlo más hacia arriba */
    right: 10px; /* Ajustado para moverlo hacia la derecha */
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: red;
    text-decoration: none;
    cursor: pointer;
}

.modalll-content p {
    margin-top: 0;
    font-size: 20px;
    color: #333;
    text-align: center; /* Añadir justificación */
}

.modalll-content button {
    background-color: #4070f4;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    display: inline-block;
    margin-top: 30px;
}

.modalll-content button:hover {
    background-color: #3450bc;
}
</style>

<!-- ====================== MODAL DE VALIDACION PARA ENTRAR A EMPLEADOS =========================== -->
<style>
    /* Estilos para la modal */
    .modalllll {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
        z-index: 9998; /* Asegura que la modal esté por encima del fondo oscuro */
    }
    .modalllll .modallllll-content {
        position: absolute;
        top: 50%;
        left: 53%;
        transform: translate(-50%, -50%);
        width: 80%; /* Ancho aumentado */
        max-width: 600px; /* Ancho máximo */
        background-color: #fefefe;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 9999; /* Asegura que el contenido esté por encima del fondo oscuro */
        text-align: center; /* Centrar texto y botón */
    }
    .modalllll .modallllll-content p {
        font-size: 20px; /* Tamaño de la fuente aumentado */
    }
    .modalllll .modallllll-close {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
</style>

</head>
<body>
    <!-- ===============Navigation================ -->
    <div class="container">
       <div class="navigation">
       <ul>

        <li>
            <a href="#">
                <span class="icon">
                    <ion-icon name="glasses"></ion-icon>
                </span>
                <span class="title">OptiClin</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/Pacientes/Pacientes_Listado.html" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="people-outline"></ion-icon>
                </span>
                <span class="title">Pacientes</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/Recetar/FormularioRecetar/Historia_Optometria_240483924998877_source/Historia_Optometria.php" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="receipt-outline"></ion-icon>
                </span>
                <span class="title">Recetar</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/Facturar/Facturar.html" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="document-outline"></ion-icon>
                </span>
                <span class="title">Facturar</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/CuentasXCobrar/CxC.html" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="cash-outline"></ion-icon>
                </span>
                <span class="title">Cuentas Por Cobrar</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/CuentasXPagar/CxP.html" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="reader-outline"></ion-icon>
                </span>
                <span class="title">Cuentas Por Pagar</span>
            </a>
        </li>
        <style>
            #employeesNavItem {
                cursor: pointer;
            }
        </style>
        <li id="employeesNavItem">
            <a onclick="checkPermission(event)" target="IframePaginas">
                <span class="icon">
                    <ion-icon name="people-outline"></ion-icon>
                </span>
                <span class="title">Empleados</span>
            </a>
        </li>

        <li>
            <a href="#">
                <span class="icon">
                    <ion-icon name="documents-outline"></ion-icon>
                </span>
                <span class="title">Reportes</span>
            </a>
        </li>

        <li>
            <a href="http://localhost:8080/Clinica_Optica/assets/Paginas/Inventario/Inventario.html"  target="IframePaginas">
                <span class="icon">
                    <ion-icon name="archive-outline"></ion-icon>
                </span>
                <span class="title">Inventario</span>
            </a>
         </li>

         <li class="logout-button">
            <a onclick="openModal(event);" target="IframePaginas"> <!-- Enlace al script PHP para cerrar sesión -->
                <span class="icon">
                    <ion-icon name="log-out-outline" style="transform: scaleX(-1);"></ion-icon> <!-- Ícono de cierre de sesión -->
                </span>
                <span class="title">Cerrar Sesión</span>
            </a>
        </li>
       </ul>
    </div>
</div>

    <!-- Modal de cierre de sesión -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="closee" onclick="closeModal()">&times;</span>
            <p>¿Estás seguro/a que deseas cerrar sesión, <span id="ModalNombre"></span>?</p>
            <button name="btnCerrarSesion" onclick="logout()">Cerrar Sesión</button>
        </div>
    </div>

    <script>
        // Función para abrir el modal
        function openModal() {
            var modal = document.getElementById("myModal");
            modal.style.display = "block";
        }

        // Función para cerrar el modal
        function closeModal() {
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
        }

        // Función para cerrar sesión
        function logout() {
            // Redirigir a la página de cierre de sesión
            window.location.href = "index.php"; // Reemplaza "logout.php" con la ruta correcta a tu script PHP de cierre de sesión
        }
    </script>



<!--=================================Main========================== -->
<div class="main">                          <!--Este es la pagina principan, donde se abriran los formularios-->
    <div class="topbar">                    <!--Este es el top, como quien dice el baner--> 
       <div class="toggle">
        <ion-icon name="menu-outline"></ion-icon>
       </div>
       
       <div class="search">
        <label>
            <input type="text" placeholder="Buscar">
            <ion-icon name="search-outline"></ion-icon>
        </label>
       </div>

       <div id="userInfo" style="margin-left: 899px; font-weight: bold; font-size: 18px; color: #512da8;"></div>

       <div  class="user" onclick="openModall()">
        <img src="assets/Imgs/User.jpg" alt="">
       </div>
    </div>

    <!-- Modal de advertencia por datos faltantes -->
    <div id="myModallDatosFaltantes" class="modalll">
    <div class="modalll-content">
        <!-- <span class="close" onclick="closeModalDatosFaltantes()">&times;</span> -->
        <p>¡<span id="userInfoo" style="font-weight: bold;"></span>, Para continuar utilizando el sistema! Por favor, complete todos los campos de su registro obligatorios. Esta acción asegurará que todos los datos necesarios estén proporcionados correctamente y evitará la aparición futura de esta notificación.</p>
        <button name="irALaModal" onclick="openModalDatosFaltantes()">Completar Datos</button>
    </div>
    </div>

    <script>
        function openModalDatosFaltantes() {
        var modalDatosFaltantes = document.getElementById("myModalUsuario");
        modalDatosFaltantes.style.display = "block";
    }
        // Obtener el nombre de usuario de alguna variable PHP
        var nombreUsuario = "<?php echo isset($_SESSION['nombre']) ? $_SESSION['nombre'] : ''; ?>";
    
        // Mostrar el nombre de usuario en el mensaje de advertencia
        var userInfo = document.getElementById("userInfoo");
        userInfo.textContent = nombreUsuario !== '' ? " " + nombreUsuario + "" : "";
    </script>

    <div id="myModalUsuario" class="modall">
        <div class="modall-content">
            <span class="closee" onclick="closeModall()">&times;</span>
            
            <!-- Aquí va tu formulario -->
            <div class="container">
                <header>Datos del Usuario</header>
                <!-- Tu formulario va aquí -->
                <form action="AgregardatosFaltantesUsuario.php" method="POST" action="#" id="myModalUsuarioo">
                    <div class="form first">
                        <div class="details personal">
                            <span class="title">Datos Proporsionados</span>
        
                            <div class="fields">
                                <!-- <div class="input-field">
                                    <label for="">ID_de_cliente</label>
                                    <input type="text" placeholder="" required>
                                </div> -->
                                    <div class="input-field">
                                        <label for="">Nombre</label>
                                        <input type="text" placeholder="Ingrese Nombre" name="nombre" required value="<?php echo isset($_SESSION['nombre']) ? $_SESSION['nombre'] : ''; ?>">
                                    </div>
        
                                <div class="input-field">
                                    <label for="">Apellido</label>
                                    <input type="text" placeholder="Ingrese Apellidos" name="apellido" required value="<?php echo isset($_SESSION['apellido']) ? $_SESSION['apellido'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Cédula</label>
                                    <input type="text" placeholder="Ingrese Cedula" name="cedula" required readonly value="<?php echo isset($_SESSION['cedula']) ? $_SESSION['cedula'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Celular</label>
                                    <input type="text" placeholder="Ingrese Numero Celular" name="celular" required readonly value="<?php echo isset($_SESSION['celular']) ? $_SESSION['celular'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Direccion</label>
                                    <input type="text" placeholder="Ingrese Direccion Residencial" name="address" required value="<?php echo isset($_SESSION['address']) ? $_SESSION['address'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Edad</label>
                                    <input type="text" placeholder="Ingrese la Edad" name="edad" required value="<?php echo isset($_SESSION['edad']) ? $_SESSION['edad'] : ''; ?>">
                                </div>

                                <div class="input-field">
                                    <label for="">Fecha de Nacimiento</label>
                                    <input type="date" placeholder="" name="fechaNacimiento" required value="<?php echo isset($_SESSION['fechaNacimiento']) ? $_SESSION['fechaNacimiento'] : ''; ?>">
                                </div>

                                <div class="input-field">
                                    <label for="sexo">Sexo</label>
                                    <select name="sexo" id="sexo">
                                        <option value="" <?php echo isset($_SESSION['sexo']) && $_SESSION['sexo'] == '' ? 'selected' : ''; ?>>
                                            Selecciona Sexo...
                                        </option>
                                        <option value="Masculino" <?php echo isset($_SESSION['sexo']) && $_SESSION['sexo'] == 'Masculino' ? 'selected' : ''; ?>>
                                            Masculino
                                        </option>
                                        <option value="Femenino" <?php echo isset($_SESSION['sexo']) && $_SESSION['sexo'] == 'Femenino' ? 'selected' : ''; ?>>
                                            Femenino
                                        </option>
                                        <option value="Prefiere no Decir" <?php echo isset($_SESSION['sexo']) && $_SESSION['sexo'] == 'Prefiere no Decir' ? 'selected' : ''; ?>>
                                            Prefiere no Decir
                                        </option>
                                    </select>
                                </div>
        
                                <div class="input-field">
                                    <label for="">Email</label>
                                    <input type="email" placeholder="Ingrese Correo Electronico" name="eMail" required readonly value="<?php echo isset($_SESSION['eMail']) ? $_SESSION['eMail'] : ''; ?>">
                                </div>
                            </div>
                        </div>
        
                        <div class="details personal">
                            <span class="title">Contacto de Emergencia</span>
        
                            <div class="fields">
                                <div class="input-field">
                                    <label for="">Nombre y Apellido</label>
                                    <input type="text" placeholder="Ingrese Nombre y Apellido" name="nombreYApellido" required value="<?php echo isset($_SESSION['nombreYApellido']) ? $_SESSION['nombreYApellido'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Celular/Telefono</label>
                                    <input type="number" placeholder="Ingrese Numero" name="celularTelefono" required value="<?php echo isset($_SESSION['celularTelefono']) ? $_SESSION['celularTelefono'] : ''; ?>">
                                </div>
        
                                <div class="input-field">
                                    <label for="">Parentesco</label>
                                    <input type="text" placeholder="Madre/Padre/Amigo..." name="parentesco"required value="<?php echo isset($_SESSION['parentesco']) ? $_SESSION['parentesco'] : ''; ?>">
                                </div>
                            </div>
        
                            <button name="saveBtn"class="saveBtn">
                                <span class="btnText">Actualizar Datos</span>
                                <i class="uil uil-save"></i>
                            </button>
        
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    function openModallAcvertencia() {
    var formElements = document.getElementById("myModalUsuarioo").querySelectorAll("input, select"); // Obtener todos los elementos de formulario dentro del modal
    var isValid = true;

    // Verificar si hay campos vacíos
    formElements.forEach(function(element) {
            if (element.value === "") {
                isValid = false;
            }
        });

    // Si hay campos vacíos, mostrar la modal de advertencia
    if (!isValid) {
        var modal = document.getElementById("myModallDatosFaltantes");
        modal.style.display = "block";
    }
    }

    function openModall(){
    document.getElementById('myModalUsuario').style.display = 'block';
    }

    function closeModall() {
    document.getElementById('myModalUsuario').style.display = 'none';
    }

    window.onclick = function(event) {
    var modal = document.getElementById('myModalUsurio');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
    }

        // Llamar a la función automáticamente cuando el documento se carga
    window.onload = function() {
        openModallAcvertencia();
    };
    </script>

    <script>
        // Obtener la información del usuario de la sesión PHP
        var nombre = "<?php echo isset($_SESSION['nombre']) ? $_SESSION['nombre'] : ''; ?>";
        var apellido = "<?php echo isset($_SESSION['apellido']) ? $_SESSION['apellido'] : ''; ?>";
        // var cedula = "<?php echo isset($_SESSION['cedula']) ? $_SESSION['cedula'] : ''; ?>";
    
        // Mostrar la información del usuario en el HTML
        var userInfoDiv = document.getElementById("userInfo");
        
        userInfoDiv.innerHTML = nombre + " " + apellido;
        var userInfoDiv = document.getElementById("ModalNombre");
        userInfoDiv.innerHTML = nombre;
    </script>




        <!-- Modal DE ALERTA DE NO TIENE PERMISO -->
        <div id="myyModal" class="modalllll">
            <div class="modallllll-content">
                <p>¡No tienes permiso para acceder a esta sección!</p>
                <button class="modallllll-close" onclick="closeModalll()">Cerrar</button>
            </div>
        </div>

    <!-- ============= Cards ============= -->
    <div class="cardBox">
        <div class="card">
            <div>
                <div class="numbers">42</div>
                <div class="cardName">Pacientes del Dia</div>
            </div>

            <div class="iconBx">
                <ion-icon name="people-outline"></ion-icon>
            </div>
        </div>

        <div class="card">
            <div>
                <div class="numbers">$25,000</div>
                <div class="cardName">Apertura de Caja</div>
            </div>

            <div class="iconBx">
                <ion-icon name="wallet-outline"></ion-icon>
            </div>
        </div>

        <div class="card"  id="openModalButton">
            <div>
                <div class="numbers">$100,000</div>
                <div class="cardName">Dinero Facturado</div>
            </div>

            <div class="iconBx">
                <ion-icon name="cash-outline"></ion-icon>
            </div>
        </div>

        <?php
        $servername = "localhost";  
        $username = "root";
        $password = "";
        $dbname = "clinica_opti";
        
        // Crear conexión
        $conn = new mysqli($servername, $username, $password, $dbname);
        
        // Verificar la conexión
        if ($conn->connect_error) {
            die("Conexión fallida: " . $conn->connect_error);
        }
        
        $sql = "SELECT CodigoFactura, Paciente, CedulaPaciente, TipoDePago, FechaCrecion, ProductoServicio, Descripcion, PagoRealizado FROM factura";
        $result = $conn->query($sql);
        ?>
        
        <!-- Estructura de la Modal -->
        <div id="myModalE" class="modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); padding-top: 20px;">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%;">
                <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; padding-top: 110px; padding-right: 205px;" onmouseover="this.style.color='red'" onmouseout="this.style.color='#aaa'">&times;</span>
        
                <p>¡Hola! Aquí va el contenido de tu modal.</p>
                
                <div class="table-container" style="max-height: calc(80vh - 50px); overflow-y: auto;">
                    <table style="margin: 0 auto; width: 100%; max-width: 700px; overflow-x: auto; white-space: nowrap; text-overflow: ellipsis;">
                        <thead style="background-color: #5c6bc0; color: white;">
                            <tr>
                                <th style="max-width: 500px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Código de Factura</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Paciente</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Fecha de Emisión</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Tipo de Pago</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Producto/Servicio</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Descripción</th>
                                <th style="max-width: 750px; border-radius: 7px; text-align: center; padding: 9.5px; height: 20px; font-size: 18px;">Pago Realizado</th>
                            </tr>
                        </thead>
                        
                        <tbody id="content">
                            <?php
                            if ($result->num_rows > 0) {
                                $data = [];
                            
                                // Recorre los resultados y agrupa por paciente
                                while($row = $result->fetch_assoc()) {
                                    $paciente = $row["Paciente"];
                                    if (!isset($data[$paciente])) {
                                        $data[$paciente] = [];
                                    }
                                    $data[$paciente][] = $row;
                                }
                            
                                // Genera la salida HTML agrupada
                                foreach ($data as $paciente => $facturas) {
                                    echo "<tr data-paciente='$paciente' style='background-color: #004080; color: #fff;'>";
                                    echo "<td colspan='7' style='font-size: 18px; font-weight: bold; padding: 10px; text-align: center; border-radius: 8px 8px 0 0;'>" . $paciente . "</td>";
                                    echo "</tr>";
                            
                                    $lastPagoRealizado = null;
                                    $colorToggle = false;
                            
                                    foreach ($facturas as $factura) {
                                        if ($lastPagoRealizado !== $factura["PagoRealizado"]) {
                                            $colorToggle = !$colorToggle;
                                            $lastPagoRealizado = $factura["PagoRealizado"];
                                        }
                            
                                        $rowColor = $colorToggle ? "#e0f7fa" : "#f9f9f9";
                            
                                        echo "<tr data-fecha='" . $factura["FechaCrecion"] . "' data-paciente='$paciente' style='background-color: " . $rowColor . "; transition: background-color 0.3s ease;'>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["CodigoFactura"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["Paciente"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["FechaCrecion"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["TipoDePago"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["ProductoServicio"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["Descripcion"] . "</td>";
                                        echo "<td style='text-align: center; font-size: 16px; padding: 12px; border-bottom: 1px solid #ddd; border-radius: 4px;'>" . $factura["PagoRealizado"] . "</td>";
                                        echo "</tr>";
                                    }
                                }
                            } else {
                                echo "<tr><td colspan='7' style='text-align: center; font-size: 18px; color: #666; padding: 20px;'>No se encontraron resultados</td></tr>";
                            }
                            ?>
                        </tbody>
        
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Obtener la fecha actual en formato YYYY-MM-DD
                                let todayISO = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                            
                                // Obtener la fecha actual en formato DD-MM-YYYY
                                let todayLocal = new Date().toLocaleDateString('es-ES').split('/').map(part => part.padStart(2, '0')).reverse().join('-'); // DD-MM-YYYY
                            
                                // Seleccionar todas las filas que tienen un atributo data-fecha
                                let rows = document.querySelectorAll('tr[data-fecha]');
                                
                                // Función para normalizar las fechas al formato YYYY-MM-DD o DD-MM-YYYY
                                function normalizeDate(date) {
                                    let parts;
                                    if (date.includes('-')) {
                                        parts = date.split('-');
                                    } else if (date.includes('/')) {
                                        parts = date.split('/');
                                    }
                            
                                    if (parts.length === 3) {
                                        if (parts[0].length === 4) {
                                            // Formato YYYY-MM-DD o YYYY/MM/DD
                                            return parts.join('-');
                                        } else {
                                            // Formato DD-MM-YYYY o DD/MM/YYYY
                                            return `${parts[2]}-${parts[1]}-${parts[0]}`;
                                        }
                                    }
                                    return date;
                                }
                            
                                // Iterar sobre cada fila y comparar la fecha
                                rows.forEach(function(row) {
                                    let rowDate = normalizeDate(row.getAttribute('data-fecha'));
                                    if (rowDate !== todayISO && rowDate !== todayLocal) {
                                        row.style.display = 'none';
                                    }
                                });
                            
                                // Ocultar las filas de pacientes sin consultas en la fecha actual
                                let pacientes = document.querySelectorAll('tr[data-paciente]');
                            
                                pacientes.forEach(function(pacienteRow) {
                                    let pacienteId = pacienteRow.getAttribute('data-paciente');
                                    let hasTodayConsult = false;
                            
                                    rows.forEach(function(row) {
                                        let rowDate = normalizeDate(row.getAttribute('data-fecha'));
                                        let rowPacienteId = row.getAttribute('data-paciente');
                            
                                        if (pacienteId === rowPacienteId && (rowDate === todayISO || rowDate === todayLocal)) {
                                            hasTodayConsult = true;
                                        }
                                    });
                            
                                    if (!hasTodayConsult) {
                                        pacienteRow.style.display = 'none';
                                    }
                                });
                            });
                            </script>
                    </table>
                </div>
            </div>
        </div>
  

    <!-- JavaScript -->
    <script>
        // Obtener la modal
        var modal = document.getElementById("myModalE");

        // Obtener el botón que abre la modal
        var btn = document.getElementById("openModalButton");

        // Obtener el elemento <span> que cierra la modal
        var span = document.getElementsByClassName("close")[0];

        // Cuando el usuario hace clic en el botón, se abre la modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // Cuando el usuario hace clic en <span> (x), se cierra la modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // Cuando el usuario hace clic fuera de la modal, se cierra
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

        <div class="card">
            <div>
                <div class="numbers">10</div>
                <div class="cardName">Ventas del Dia</div>
            </div>

            <div class="iconBx">
                <ion-icon name="cart-outline"></ion-icon>
            </div>
        </div>
        
    </div>
    <style>
        #miIframePacientes {
            position: fixed;
            margin: 0%;
            
        }
    </style>
    <iframe  id="miIframePacientes" width="85%" height="749px" name="IframePaginas" scrolling="auto"></iframe>
</div>

<script>
    function checkPermission(event) {
        // Evitar el comportamiento predeterminado del enlace
        event.preventDefault();
        
        // Obtener el departmentId del usuario desde PHP
        var departmentId = "<?php echo $departmentId; ?>";
    
        // Verificar si el departmentId no es "Encargado" ni "Gerente"
        if (departmentId !== "Encargado" && departmentId !== "Gerente") {
            // Mostrar una modal con el mensaje de error
            document.getElementById('myyModal').style.display = "block";
                    // Agregar estilos a la alerta
        } else {
            // Redirigir a la página de empleados si el usuario tiene permiso
            document.getElementById('miIframePacientes').src = 'http://localhost:8080/Clinica_Optica/assets/Paginas/Empleados/ListadoDeEmpleados.html';
        }
    }
    function closeModalll() {
    document.getElementById('myyModal').style.display = "none";
}

</script>
<!--========== Scripts ============ Ruta de Jv Script-->
<script src="assets/js/main.js"></script>
<!--========== ionicons/ iconos ============-->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

</body>
</html>
