<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Facturación - Clínica Óptica</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
    
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Ubuntu', sans-serif;
            scroll-behavior: auto;
        }
        .right-column {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-end; /* Alinea el contenido al extremo derecho */
        }

        body {
            background-color: #c9d6ff;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100vh;
        }

        .container {
            background-color: #fff;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35);
            position: relative;
            overflow: hidden;
            width: 99%;
            max-width: 100%;
            min-height: 733px;
            display: flex;
            flex-direction: row;
        }

        .left-column,
        .right-column {
            flex: 1;
            padding: 20px;
        }

        h2{
            margin-top: 0px;
        }

        #h22{
            margin-top: 35px;
        }
        form {
            max-width: 485px;
            margin: 0 auto;
        }

        table {
            width: 95%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
            font-size: 14px;
            border: 0px solid #5c6bc0;
            text-align: center;
            padding: 8px;
        }

        th {
            background-color: #5c6bc0;
            color: white;
            border-radius: 110px;
        }
        td {
            border-radius: 5px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        td:hover,
        tr:hover td {
        background-color: #c5cae9;
        }

        label {
            font-size: 14px;
            margin-bottom: 5px;
            display: block;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            background-color: #eee;
            border: none;
            margin-bottom: 10px;
            padding: 10px 20px;
            font-size: 17px;
            border-radius: 8px;
            width: 250px;
            outline: none;
        }

        .right-column{
            margin-right: 165px;
        }

        textarea {
        margin-top: 35px;
        width: 500px;
        max-width: 500px;
        height: 180px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        outline: none;
        margin-left: 25px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.35);
        }


        button {
        background-color: #512da8;
        border-radius: 8px;
        width: 250px;
        color: #fff;
        font-size: 14px;
        padding: 10px 45px;
        border: 1px solid transparent;
        border-radius: 8px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        cursor: pointer;
        transition: background-color 0.3s;
        position: absolute;
        bottom: 20px; /* Ajusta la distancia desde la parte inferior */
        left: 85%; /* Coloca el botón en el centro horizontalmente */
        transform: translateX(-50%); /* Centra horizontalmente el botón */
        }

        button:hover {
            background-color: #311b92;
        }

        .RecetaAnteojos {
        margin-top: 250px; /* Ajusta este valor según sea necesario */
        margin-left: -540px;
        }

/* ESTILOS DE LA MODAL */
/* Estilos para el modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  
  background-color: rgba(0, 0, 0, 0.4);
}

/* Contenido del modal */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 50%;
  margin-top: 50px;
  border-radius: 15px;
}

p{
    margin-bottom: 50px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    color:     #512da8;
}

.label{
    margin-bottom: 10px;
    font-size: 15px;
    font-weight: bold;
}

#btn{
        background-color: #512da8;
        border-radius: 8px;
        width: 250px;
        color: #fff;
        font-size: 14px;
        padding: 10px 45px;
        border: 1px solid transparent;
        border-radius: 8px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        cursor: pointer;
        transition: background-color 0.3s;
        position: absolute;
        bottom: 60%;
        left: 65%; /* Coloca el botón en el centro horizontalmente */
        transform: translateX(-50%);  /* Centra horizontalmente el botón */
}

/* Estilos para el botón de cerrar */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
        
    </style>
</head>
<body>
   

    <div class="container">

        <div class="left-column">
            <h2 id="h2" style="font-size:17px ;">Listado de Recetas para Facturar:</h2>

            <div style="overflow-y: auto; max-height: 275px; width: 800px;">
            <table class="table-container">
                <thead>
                </thead>
                <tbody id="content">
                    <?php
                    // Conexión a la base de datos
                    $servername = "localhost";
                    $username = "root";
                    $password = "";
                    $dbname = "clinica_opti";
                    
                    // Crear conexión
                    $conn = new mysqli($servername, $username, $password, $dbname);
                    
                    // Verificar la conexión
                    if ($conn->connect_error) {
                        die("Conexión fallida: " . $conn->connect_error);
                    }
                    
                    // Consulta SQL para seleccionar todos los datos de la tabla
                    $sql = "SELECT CedulaPaciente, NombrePaciente, ApellidoPaciente, EdadPaciente, DoctorEncargado,FechaConsullta, NotasAdicionales, OjoDerechoES, OjoDerechoCIL, OjoDerechoEJE, OjoDerechoADD, OjoDerechoAVv, OjoDerechoDP, OjoIzquierdoES, OjoIzquierdoCIL, OjoIzquierdoEJE, OjoIzquierdoADD, OjoIzquierdoAVv, OjoIzquierdoDP, IDConsultaSinFacturar FROM consultassinfacturar";
                    $result = $conn->query($sql);
                    ?>
                    <table class="table-container">
                        <thead>
                            <tr>
                                <th>Cedula</th>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>Edad</th>
                                <th>Doctor</th>
                                <th>Fecha</th>
                                <th>Accion</th>
                            </tr>
                        </thead>
                        <tbody id="content">
                            <?php
                            // Imprimir los datos de la tabla en la tabla HTML
                            if ($result->num_rows > 0) {

                                while($row = $result->fetch_assoc()) {

                                    echo "<tr>";
                                    $cedulaCompleta = $row["CedulaPaciente"];
                                    $ultimosCuatro = substr($cedulaCompleta, -4); // Obtiene los últimos cuatro dígitos de la cédula
                                    echo "<td>" . $ultimosCuatro . "</td>";
                                    echo "<td>" . $row["NombrePaciente"] . "</td>";
                                    echo "<td>" . $row["ApellidoPaciente"] . "</td>";
                                    echo "<td>" . $row["EdadPaciente"] . " años</td>";
                                    echo "<td>" . $row["DoctorEncargado"] . "</td>";
                                    echo "<td>" . $row["FechaConsullta"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["NotasAdicionales"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoES"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoCIL"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoEJE"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoADD"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoAVv"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoDerechoDP"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoES"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoCIL"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoEJE"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoADD"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoAVv"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoDP"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["OjoIzquierdoDP"] . "</td>";
                                    echo "<td style='display: none;'>" . $row["IDConsultaSinFacturar"] . "</td>";


                                    echo "<td><div><a href='' class='facturar' style='color:red; text-decoration: none; cursor: pointer;'><span style='font-weight: bold;'><strong>Facturar</strong></span></a></div></td>";
                                    echo "</tr>";   
                                }
                            } else {
                                echo "<tr><td colspan='6'>No se encontraron resultados</td></tr>";
                            }
                            ?>
                        </tbody>
                    </table>
                    <?php
                    // Cerrar conexión a la base de datos
                    $conn->close();
                    ?>
                </tbody>
            </table>
            </div>

            <!-- Enviar los datos a los Inputs -->
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    // Obtener el botón de facturar
                    var facturarButtons = document.querySelectorAll(".facturar");
                    
                    // Asignar evento de clic a cada botón
                    facturarButtons.forEach(function(button) {
                        button.addEventListener("click", function(event) {
                            event.preventDefault(); // Evitar que el enlace se siga
                    
                            // Obtener los datos del paciente de la fila
                            var cedula = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(1)").textContent;
                            var nombre = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(2)").textContent;
                            var apellido = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(3)").textContent;
                            var edad = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(4)").textContent;
                            var doctor = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(5)").textContent;
                            var fechaConsulta = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(6)").textContent;

                            // Obtener los datos del paciente de la fila Notas del Doctor y La RX de los Lenntes
                            var notasAdicionales = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(7)").textContent;
                            var ojoDerechoES = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(8)").textContent;
                            var ojoDerechoCIL = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(9)").textContent;
                            var ojoDerechoEJE = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(10)").textContent;
                            var ojoDerechoADD = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(11)").textContent;
                            var ojoDerechoAVv = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(12)").textContent;
                            var ojoDerechoDP = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(13)").textContent;
                            var ojoIzquierdoES = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(14)").textContent;
                            var ojoIzquierdoCIL = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(15)").textContent;
                            var ojoIzquierdoEJE = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(16)").textContent;
                            var ojoIzquierdoADD = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(17)").textContent;
                            var ojoIzquierdoAVv = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(18)").textContent;
                            var ojoIzquierdoDP = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(19)").textContent;
                            var idConsultaSinFacturar = button.parentNode.parentNode.parentNode.querySelector("td:nth-child(21)").textContent;

                            
                            // Asignar los datos a los inputs
                            document.getElementById("nombre").value = nombre +" "+ apellido;
                            document.getElementById("cedula").value = cedula;
                            document.getElementById("edad").value = edad;
                            document.getElementById("fechaConsultaa").value = fechaConsulta;
                            document.getElementById("fechaConsulta").value = fechaConsulta;
                            calcularFechaExpiracion(); //Funcion para calcular los 30 dias en base a la fecha de creacion
                            document.getElementById("doctor").value = doctor;

                            // Asignar los datos a los inputs RX de 
                            document.getElementById("notasAdicionales").value = notasAdicionales;
                            document.getElementById("notasAdicionalesForm").value = notasAdicionales;
                            document.getElementById("OjoDerechoES").value = ojoDerechoES;
                            document.getElementById("OjoDerechoCIL").value = ojoDerechoCIL;
                            document.getElementById("OjoDerechoEJE").value = ojoDerechoEJE;
                            document.getElementById("OjoDerechoADD").value = ojoDerechoADD;
                            document.getElementById("OjoDerechoAVv").value = ojoDerechoAVv;
                            document.getElementById("OjoDerechoDP").value = ojoDerechoDP;

                            document.getElementById("OjoIzquierdoES").value = ojoIzquierdoES;
                            document.getElementById("OjoIzquierdoCIL").value = ojoIzquierdoCIL;
                            document.getElementById("OjoIzquierdoEJE").value = ojoIzquierdoEJE;
                            document.getElementById("OjoIzquierdoADD").value = ojoIzquierdoADD;
                            document.getElementById("OjoIzquierdoAVv").value = ojoIzquierdoAVv;
                            document.getElementById("OjoIzquierdoDP").value = ojoIzquierdoDP;

                            // Asignar los datos a los inputs del Form para enviarlos.
                            document.getElementById("OjoDerechoESs").value = ojoDerechoES;
                            document.getElementById("OjoDerechoCILl").value = ojoDerechoCIL;
                            document.getElementById("OjoDerechoEJEe").value = ojoDerechoEJE;
                            document.getElementById("OjoDerechoADDd").value = ojoDerechoADD;
                            document.getElementById("OjoDerechoAVvv").value = ojoDerechoAVv;
                            document.getElementById("OjoDerechoDPp").value = ojoDerechoDP;

                            document.getElementById("OjoIzquierdoESs").value = ojoIzquierdoES;
                            document.getElementById("OjoIzquierdoCILl").value = ojoIzquierdoCIL;
                            document.getElementById("OjoIzquierdoEJEe").value = ojoIzquierdoEJE;
                            document.getElementById("OjoIzquierdoADDd").value = ojoIzquierdoADD;
                            document.getElementById("OjoIzquierdoAVvv").value = ojoIzquierdoAVv;
                            document.getElementById("OjoIzquierdoDPp").value = ojoIzquierdoDP;
                            document.getElementById("IdConsultaSinFacturar").value = idConsultaSinFacturar;
                        });
                    });
                });
                </script>

<script>
    // Agregar evento de clic al botón "Seleccionar"
    document.addEventListener("DOMContentLoaded", function() {
        var seleccionarButtons = document.querySelectorAll(".seleccionar");

        seleccionarButtons.forEach(function(button) {
            button.addEventListener("click", function(event) {
                event.preventDefault();

                // Obtener los detalles del producto seleccionado
                var fila = button.closest("tr");
                var producto = fila.querySelector("td:nth-child(1)").textContent;
                var descripcion = fila.querySelector("td:nth-child(2)").textContent;
                var categoria = fila.querySelector("td:nth-child(3)").textContent;
                var cantidad = parseInt(fila.querySelector("td:nth-child(4)").textContent); // Convertir la cantidad a un número entero
                var precio = fila.querySelector("td:nth-child(5)").textContent;

                // Verificar si la cantidad seleccionada es mayor que la cantidad en stock
                var cantidadSeleccionada = parseInt(prompt("Ingrese la cantidad que desea seleccionar:"));
                if (isNaN(cantidadSeleccionada)) {
                    // Si el usuario ingresa algo que no es un número, muestra un mensaje de error
                    alert("Ingrese un número válido para la cantidad.");
                    return; // Salir de la función si la cantidad no es válida
                } else if (cantidadSeleccionada > cantidad) {
                    // Si la cantidad seleccionada es mayor que la cantidad en stock, muestra un mensaje de alerta
                    alert("La cantidad seleccionada es mayor que la cantidad en stock.");
                    return; // Salir de la función si la cantidad es mayor que el stock
                }

                // Agregar los detalles al segundo TextArea
                var detalles = "Producto: " + producto + "\n" +
                               "Descripción: " + descripcion + "\n" +
                               "Categoría: " + categoria + "\n" +
                               "Cantidad: " + cantidadSeleccionada + "\n" + // Usar la cantidad seleccionada en lugar de la cantidad en stock
                               "Precio: " + precio + "\n\n";

                var segundaTextArea = document.getElementById("FacturarInventario");
                segundaTextArea.value += detalles;

                // Calcular el total
                var total = precio * cantidadSeleccionada;

                // Calcular el precio con descuento
                var descuento = parseFloat(fila.querySelector("td:nth-child(6)").textContent); // Obtener el descuento del producto
                var precioConDescuento = precio - descuento; // Calcular el precio con descuento

                // Agregar los detalles a la tabla de facturación
                var tablaFacturacionBody = document.getElementById("tablaFacturacionBody");
                var filaNueva = "<tr>" +
                "<td>" + producto + "</td>" +
                "<td>" + descripcion + "</td>" +
                "<td>" + categoria + "</td>" +
                "<td>" + precioConDescuento.toFixed(2) + "</td>" + // Mostrar el precio con descuento
                "<td>" + cantidadSeleccionada + "</td>" + // Usar la cantidad seleccionada en lugar de la cantidad en stock
                "<td>" + descuento.toFixed(2) + "</td>" +
                "<td>" + (precioConDescuento * cantidadSeleccionada).toFixed(2) + "</td>" + // Calcular y mostrar el total con descuento

                "<td><div><a href='' class='eliminar' style='color:red; text-decoration: none; cursor: pointer;'><span style='font-weight: bold;'><strong>Eliminar</strong></span></a></div></td>" + // Cambiar el texto del enlace a "Eliminar"
                "</tr>";
                tablaFacturacionBody.innerHTML += filaNueva;

                // Calcular el total a pagar
                var filas = document.querySelectorAll("#tablaFacturacionBody tr");
                var totalAPagar = 0;

                filas.forEach(function(fila) {
                var totalFila = parseFloat(fila.querySelector("td:nth-child(7)").textContent);
                totalAPagar += totalFila;
                });

                // Mostrar el total a pagar en el input correspondiente
                document.getElementById("TotalAPagar").value = totalAPagar.toFixed(2); // Redondear a 2 decimales

                var enlacesEliminar = tablaFacturacionBody.querySelectorAll(".eliminar");
                enlacesEliminar.forEach(function(enlace) {
                    enlace.addEventListener("click", function(event) {
                        event.preventDefault();
                        // Eliminar la fila
                        var filaPadre = this.closest("tr");
                        filaPadre.parentNode.removeChild(filaPadre);
                        // Volver a calcular el total a pagar
                        var nuevasFilas = document.querySelectorAll("#tablaFacturacionBody tr");
                        var nuevoTotalAPagar = 0;
                        nuevasFilas.forEach(function(nuevaFila) {
                            var totalFila = parseFloat(nuevaFila.querySelector("td:nth-child(6)").textContent);
                            nuevoTotalAPagar += totalFila;
                        });
                        document.getElementById("TotalAPagar").value = nuevoTotalAPagar.toFixed(2);
                   });
                });
            });
        });
    });
    </script>

            <h2 id="h22" style="font-size:17px ;">Productos y Servicios (Inventario):</h2>
            <div style="overflow-y: auto; max-height: 328px; width: 800px;">
            <table class="table-container">
                <thead>
                </thead>
                
                    <tbody id="content">
                        <!-- Aquí puedes insertar filas con datos de productos y servicios -->
                        <?php
                        // Conexión a la base de datos
                        $servername = "localhost";
                        $username = "root";
                        $password = "";
                        $dbname = "clinica_opti";
                        
                        // Crear conexión
                        $conn = new mysqli($servername, $username, $password, $dbname);
                        
                        // Verificar la conexión
                        if ($conn->connect_error) {
                            die("Conexión fallida: " . $conn->connect_error);
                        }
                        
                        // Consulta SQL para seleccionar todos los datos de la tabla
                        $sql = "SELECT IdProductoServicio, ProductoOServicio, Descripcion, Categoria,CantidadEnStock, PrecioParaCliente, Descuento FROM inventario";
                        $result = $conn->query($sql);
                        
                        ?>
                        <table class="table-container">
                    <thead>
                    <tr>
                        <!-- <th>Producto/Servicio</th> -->
                        <th>Descripcion </th>
                        <th>Categoria</th>
                        <th>Stock</th>
                        <th>Precio</th>
                        <th>Descuento</th>
                        <th>Accion</th>
                    </tr>
                    </thead>
                    <tbody id="content">
                        <?php
                        // Imprimir los datos de la tabla en la tabla HTML
                        if ($result->num_rows > 0) {
                            while($row = $result->fetch_assoc()) {
                                echo "<tr>";
                                    echo "<td style='display: none;'>" . $row["ProductoOServicio"] . "</td>";
                                echo "<td>" . $row["Descripcion"] . "</td>";
                                echo "<td>" . $row["Categoria"] . "</td>";
                                echo "<td>" . $row["CantidadEnStock"] . "</td>";
                                echo "<td>" . $row["PrecioParaCliente"] . "</td>";
                                echo "<td>" . $row["Descuento"] . "</td>";
                                echo "<td><div><a class='seleccionar' href='' onclick='agregarProducto(this)' style='color:red; text-decoration: none; cursor: pointer;'><span style='font-weight: bold;'><strong>Seleccionar</strong></span></a></div></td>";
                                echo "</tr>";
                            }
                        } else {
                            echo "<tr><td colspan='5'>No se encontraron resultados</td></tr>";
                        }
                        ?>
                    </tbody>
                    </table>
                    <?php
                    // Cerrar conexión a la base de datos
                    $conn->close();
                    ?>
                </tbody>
            </table>

        </div>
        </div>

        <script>
            // Función para manejar el evento de seleccionar una fila
            function agregarProducto(elemento) {
                // Obtener la fila padre del elemento seleccionar
                var fila = elemento.closest('tr');
        
                // Obtener el descuento de la fila seleccionada
                var descuento = parseFloat(fila.cells[5].innerText);
        
                // Verificar si ya hay una suma de descuentos existente
                var sumaActual = parseFloat(document.getElementById('sumaDescuentos').value);
        
                // Si no hay una suma existente, asignar el descuento de la fila seleccionada
                // Si hay una suma existente, sumar el descuento de la fila seleccionada
                var nuevaSuma = isNaN(sumaActual) ? descuento : sumaActual + descuento;
        
                // Mostrar la suma de descuentos en el input
                document.getElementById('sumaDescuentos').value = nuevaSuma.toFixed(2);
            }
        </script>

        <div  style="display: flex; flex-direction: column; margin-top: 0;">
        <textarea name="" id="notasAdicionales" cols="30" rows="10" readonly>A Facturar...</textarea>
        </div>
        
        <div class="RecetaAnteojos" style="position: center ;">
            <table>
                <thead>
                    <tr>
                        <th style="background-color:#fff"></th>
                        <th >Es</th>
                        <th style="width: 5px;">Cil</th>
                        <th style="width: 5px;">E</th>
                        <th style="width: 5px;">Add</th>
                        <th style="width: 5px;">AV</th>
                        <th style="width: 5px;">DP</th>
                    </tr>
                </thead>
                <tbody>
            <h1 style="font-size:17px ; margin-left: 40px;">Receta de Anteojos:</h1>
                    <tr>
                        <td><strong>OD</strong></td>
                        <td><input type="text" id="OjoDerechoES"   name="OjoDerechoES" style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoDerechoCIL"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoDerechoEJE"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoDerechoADD"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoDerechoAVv"  style="background-color:#fff; font-size: 15px; width: 80px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoDerechoDP"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                    </tr>
                    <tr style="background-color:#fff;">
                        <td><strong>OI</strong></td>
                        <td><input type="text" id="OjoIzquierdoES"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoIzquierdoCIL"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoIzquierdoEJE"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoIzquierdoADD"  style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoIzquierdoAVv"  style="background-color:#fff; font-size: 15px; width: 80px; height: 35px; font-weight: bold;" required readonly></td>
                        <td><input type="text" id="OjoIzquierdoDP" style="background-color:#fff; font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required readonly></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- LO QUE SE FACTURARA EN EL INVENTARIO -->
        <div class="AFacturarProductoServicio" style="position: center ; margin-top: 465px; margin-left: -560px; width: 25% ;">
            <h1 style="font-size: 17px; margin-top: 0; margin-bottom: 0;">Producto/Servicio a facturar</h1>
            <table id="FacturarInventario">
                <thead>
                    <tr>
                        <th style="width: 5px;">Tipo</th>
                        <th style="width: 5px;">Descripción</th>
                        <th style="width: 5px;">Categoría</th>
                        <th style="width: 5px;">Precio</th>
                        <th style="width: 5px;">Cantidad</th>
                        <th style="width: 5px;">Descuento</th>
                        <th style="width: 5px;">Total</th>
                        <th style="width: 5px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaFacturacionBody"> <!-- Agregar un ID único al tbody -->
                                            <!-- Aquí se agregarán las filas de la tabla de facturación -->
                </tbody>
            </table>
        </div>

        <script>
            // Matriz para almacenar las filas
            var filas = [];
        
            // Seleccionar el cuerpo de la tabla
            var tbody = document.getElementById("tablaFacturacionBody");
        
        // Crear un observador de mutación
        var observer = new MutationObserver(function(mutationsList) {
            for(var mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    // No agregamos automáticamente las filas a la matriz
                    // para evitar duplicados
                }
            }
        });
        // Observar cambios en el cuerpo de la tabla
        observer.observe(tbody, { childList: true });
        // Función para agregar todas las filas a la matriz
        function agregarFilasAMatriz() {
            // Reiniciar la matriz
            filas = [];
            // Obtener todas las filas de la tabla
            var rows = tbody.getElementsByTagName('tr');
            // Iterar sobre las filas y agregarlas a la matriz
            for (var i = 0; i < rows.length; i++) {
                filas.push(rows[i]);
            }
            // Mostrar la matriz en la consola (para propósitos de demostración)
            console.log(filas);
        }
            // // Ejemplo de cómo agregar una fila manualmente (para propósitos de demostración)
            // function agregarFila() {
            //     var newRow = document.createElement('tr');
            //     newRow.innerHTML = '<td>Tipo</td><td>Descripción</td><td>Categoría</td><td>Precio</td><td>Cantidad</td><td>Total</td>';
            //     tbody.appendChild(newRow);
            // }
        </script>


        <div class="right-column"></div>        
            <form id="formularioFactura" action="GenerarFactura.php" method="post" style="margin-right: 30px; margin-top: -210px;">

                <input type="hidden" id="OjoDerechoESs" name="OjoDerechoESs" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoDerechoCILl" name="OjoDerechoCILl" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoDerechoEJEe" name="OjoDerechoEJEe" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoDerechoADDd" name="OjoDerechoADDd" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoDerechoAVvv" name="OjoDerechoAVvv" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoDerechoDPp"  name="OjoDerechoDPp" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>

                <input type="hidden" id="OjoIzquierdoESs" name="OjoIzquierdoESs" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoIzquierdoCILl" name="OjoIzquierdoCILl" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoIzquierdoEJEe"name="OjoIzquierdoEJEe" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoIzquierdoADDd" name="OjoIzquierdoADDd" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoIzquierdoAVvv" name="OjoIzquierdoAVvv" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>
                <input type="hidden" id="OjoIzquierdoDPp" name="OjoIzquierdoDPp" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>

                
                
                <div style="display: flex; flex-direction: column; margin-top: 0;">
                    <textarea name="notasAdicionalesForm" id="notasAdicionalesForm" cols="30" rows="10" readonly>A Facturar...</textarea>
                </div>
                <!-- ocultar el text tarea adicional -->
                <script>
                    document.getElementById("notasAdicionalesForm").style.visibility = "hidden";
                </script>

                <input type="hidden" id="IdConsultaSinFacturar" name="IdConsultaSinFacturar" style=" font-size: 15px; width: 70px; height: 35px; font-weight: bold;" required>

                <input type="hidden" id="doctor" name="doctor" style="font-size: 15px;" required> <!-- input del nombre del Doctor  -->

                <input type="hidden" id="edad" name="edad" style="font-size: 15px;" required>  <!-- input de la edad del paciente  -->

                <label for="nombre" style="font-weight: bold;">Nombre y Apellido del Paciente:</label>
                <input type="text" id="nombre" name="nombre" style="font-size: 15px;" required readonly>
                
                <label style="font-weight: bold;">Cédula del Paciente:</label>
                <input type="text" id="cedula" name="cedula" style="font-size: 15px;" required readonly>

                <label for="fecha" style="font-weight: bold;">Fecha de Consulta:</label>
                <input type="date" id="fechaConsulta" name="fechaConsulta"style="font-size: 15px;" required readonly>

                <!-- Colocar monto a devolver -->
                <label for="dni" style="font-weight: bold;">RNC: <span style="color: red; font-size: 20px;">*</span></label>
                <input type="text" id="dni" name="dni" style="font-size: 15px;" required>

                <!-- <label for="fechaConsulta" style="font-weight: bold;">Fecha de creación:</label> -->
                <input type="hidden" type="date" id="fechaConsultaa" name="fechaConsultaa" style="font-size: 15px;" onchange="calcularFechaExpiracion()" required>
            
                <label for="fechaExpiracion" style="font-weight: bold;">Fecha de expiración:</label>
                <input type="text" id="fechaExpiracion" name="fechaExpiracion" style="font-size: 15px;" required readonly>

                <label style="font-weight: bold;">Total a Pagar:</label>
                <input type="number" id="TotalAPagar" name="TotalAPagar" style="font-size: 20px;" required readonly>

                <label for="metodoPago" style="font-weight: bold;">Método de Pago: <span style="color: red; font-size: 20px;">*</span></label>

                <select id="metodoPago" name="metodoPago" style="font-size: 15px;" required>
                    <option value="" disabled selected>Selecciona el método de Pago...</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Depósito">Depósito</option>
                    <option value="Efectivo-Tarjeta">Efectivo-Tajeta</option>                    
                    <option value="Efectivo-Depósito">Efectivo-Depósito</option>
                    <option value="Efectivo-Tajarjeta-Depósito">Efectivo-Tajarjeta-Depósito</option>
                    <option value="Nota de Crédito">Nota de Crédito</option>
                    <option value="Cheque">Cheque</option>
                </select>

                <label style="font-weight: bold;">Pago de Paciente: <span style="color: red; font-size: 20px;">*</span></label>
                <input type="number" id="PagoRealizado" name="PagoRealizado" style="font-size: 20px;" required>

                <label style="font-weight: bold;">Monto a Devolver:</label>
                <input type="number" id="PagoADevolver" name="PagoADevolver" style="font-size: 20px;" required readonly>
                <input type="hidden" id="valorNegativo" name="valorNegativo" value="0">
                
                                <script>
                                    function calcularFechaExpiracion() {
                                        var fechaCreacionInput = document.getElementById("fechaConsultaa").value;
                                        var fechaCreacion = new Date(fechaCreacionInput);
                                        var fechaExpiracion = new Date(fechaCreacion.getTime() + (30 * 24 * 60 * 60 * 1000));
                                        
                                        var fechaExpiracionTexto = formatDate(fechaExpiracion);
                                        
                                        document.getElementById("fechaExpiracion").value = fechaExpiracionTexto;
                                    }
                                    
                                    function formatDate(date) {
                                        var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                                        return date.toLocaleDateString('es-ES', options);
                                    }
                                    
                                    // Calcula la fecha de expiración al cargar la página (si hay una fecha de creación previamente seleccionada)
                                    window.onload = function() {
                                        calcularFechaExpiracion();
                                    };
                                    </script>
                <script>
                    function generarFactura() {
                        // Obtener valores de los campos de entrada

                        var nombre = document.getElementById('nombre').value;
                        var cedula = document.getElementById('cedula').value;
                        var fechaConsulta = document.getElementById('fechaConsulta').value;
                        var metodoPago = document.getElementById('metodoPago').value;
                        var dni = document.getElementById('dni').value; //RNC 
                        var fechaExpiracion = document.getElementById('fechaExpiracion').value;
                        var TotalAPagar = document.getElementById('TotalAPagar').value;
                        var PagoRealizado = document.getElementById('PagoRealizado').value;
                        var PagoADevolver = document.getElementById('PagoADevolver').value;

                        var OjoDerechoESs = document.getElementById('OjoDerechoESs').value;
    
                        // Asignar valores a campos de entrada ocultos
                        document.getElementById('doctor').value = doctor;
                        document.getElementById('edad').value = edad;

                        

                        // document.getElementById("OjoDerechoESs").value = ojoDerechoES;
                        // Obtener otros valores de campos de entrada de la receta de anteojos...
                        // Enviar el formulario
                        document.getElementById('formularioFactura').submit();
                    }
                </script>

<script>
function enviarFilas() {
    // Obtener el formulario
    var formulario = document.getElementById('formularioFactura');

    // Recorrer la matriz de filas
    for (var i = 0; i < filas.length; i++) {
        // Crear una entrada oculta para cada fila
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'fila' + i; // Asignar un nombre único a cada entrada oculta
        input.value = filas[i].innerHTML; // Guardar el contenido HTML de la fila en el valor del input
        formulario.appendChild(input); // Agregar la entrada oculta al formulario
    }

    // Enviar el formulario
    formulario.submit();
}
</script>

<script>
    function validarFormulario() {
        // Obtener todos los campos del formulario
        var inputs = document.querySelectorAll('#formularioFactura input, #formularioFactura select');

        // Iterar sobre cada campo
        for (var i = 0; i < inputs.length; i++) {
            // Verificar si el campo está vacío
            if (!inputs[i].value.trim()) {
                // Mostrar un mensaje de error (puedes personalizar este mensaje)
                alert('Por favor, complete todos los campos antes de enviar el formulario.');
                // Detener el envío del formulario
                return false;
            }
        }
        // Si todos los campos están llenos, enviar el formulario
        return true;
    }
</script>
            <button type="submit" style="margin-left: 95px;" onclick="if(validarFormulario()) { agregarFilasAMatriz(); enviarFilas(); }">Generar Factura</button>
            </form>


    <!-- Modal Efectivo-Tarjeta -->
    <div id="modalEfectivoTarjeta" class="modal">
    <!-- Contenido del modal -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <p>Introduce las cantidades: Tarjeta-Efectivo.</p>
      <p></p>
      <label class="label" for="">Introduce la cantidad en tarjeta:</label>
      <input name="input-tarjeta" type="number">
      <label class="label" for="">Introduce la cantidad en efectivo:</label>
      <input name="input-efectivo" type="number">

      <button class="close"  id="btn">Ingresar</button>
    </div>
    </div>

        <!-- Modal Efectivo-Depósito -->
        <div id="modalEfectivoDeposito" class="modal">
            <!-- Contenido del modal -->
            <div class="modal-content">
              <span class="close">&times;</span>
              <p>Introduce las cantidades: Efectivo-Depósito</p>
              <p></p>
              <label class="label"for="">Introduce la cantidad en depósito:</label>
              <input name="input-deposito" type="number">

              <label  class="label" for="">Introduce la cantidad en efectivo:</label>
              <input name="input-efectivo" type="number">

              <button class="close"  type="number" id="btn">Ingresar</button>
            </div>
            </div>

            <!-- Modal Efectivo-Tarjeta-Depósito -->
            <div id="modalEfectivoTarjetaDeposito" class="modal">
                <!-- Contenido del modal -->
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <p>Introduce las cantidades: Efectivo-Tarjeta-Depósito</p>
                  <p></p>
                  <label class="label" for="">Introduce la cantidad en tarjeta:</label>
                  <input name="input-tarjeta" type="number">

                  <label class="label" for="">Introduce la cantidad en depósito:</label>
                  <input name="input-deposito" type="number">

                  <label class="label"  for="">Introduce la cantidad en efectivo:</label>
                  <input name="input-efectivo" type="number">

                  <button class="close" id="btn" style="bottom: 50%;">Ingresar</button>
                </div>
                </div>

  <script>
  // Obtener el elemento select
  var metodoPagoSelect = document.getElementById("metodoPago");

  // Agregar un event listener para detectar cambios en el select
  metodoPagoSelect.addEventListener("change", function() {
  // Obtener el valor seleccionado
  var selectedOption = metodoPagoSelect.value;
  
  // Obtener la modal correspondiente según la opción seleccionada
  var modal;
  var modalContent;
  
  if (selectedOption === "Efectivo-Tarjeta") {
    modal = document.getElementById("modalEfectivoTarjeta");
    modalContent = modal.querySelector('.modal-content');
  } else if (selectedOption === "Efectivo-Depósito") {
    modal = document.getElementById("modalEfectivoDeposito");
    modalContent = modal.querySelector('.modal-content');
  } else if (selectedOption === "Efectivo-Tajarjeta-Depósito") {
    modal = document.getElementById("modalEfectivoTarjetaDeposito");
    modalContent = modal.querySelector('.modal-content');
  }
  
  // Mostrar la ventana modal si se encontró una modal correspondiente
  if (modal) {
    modal.style.display = "block";
    // Aquí puedes agregar cualquier lógica adicional para manipular el contenido de la modal si es necesario
  }
});

// Obtener todos los elementos de cierre de las modales
var closeBtns = document.querySelectorAll(".close");

// Agregar un event listener para cerrar las modales cuando se haga clic en los botones de cierre
closeBtns.forEach(function(closeBtn) {
  closeBtn.addEventListener("click", function() {
    var modal = closeBtn.parentElement.parentElement;
    modal.style.display = "none";
  });
});
  </script>

<!-- CALCULAR LOS MONTOS INGRESADOS EN LA MODAL -->
  <script>
// Esperar a que se cargue completamente el DOM
document.addEventListener("DOMContentLoaded", function() {
  // Obtener los elementos relevantes
  var totalAPagarInput = document.getElementById('TotalAPagar');
  var pagoRealizadoInput = document.getElementById('PagoRealizado');
  var pagoADevolverInput = document.getElementById('PagoADevolver');
  var modalInputs = document.querySelectorAll('.modal input[type="number"]');

  // Función para calcular el monto a devolver
  function calcularMontoADevolver() {
    var totalAPagar = parseFloat(totalAPagarInput.value) || 0;
    var pagoRealizado = parseFloat(pagoRealizadoInput.value) || 0;
    var montoADevolver = pagoRealizado - totalAPagar;

    // Mostrar el monto a devolver en el campo correspondiente
    pagoADevolverInput.value = montoADevolver.toFixed(2); // Redondear a 2 decimales

    // Cambiar el color del texto en base al monto a devolver
    if (montoADevolver < 0) {
      // Si el monto a devolver es negativo, poner el texto en rojo
      pagoADevolverInput.style.color = 'red';
    } else {
      // Si el monto a devolver es positivo, poner el texto en verde
      pagoADevolverInput.style.color = 'green';
    }
  }

  // Función para actualizar el pago realizado
  function actualizarPagoRealizado() {
    // Calcular el total pagado sumando los valores de todos los inputs dentro de las modales
    var totalPagado = 0;
    modalInputs.forEach(function(input) {
      totalPagado += parseFloat(input.value) || 0;
    });
    // Asignar el total pagado al input fuera de la modal
    pagoRealizadoInput.value = totalPagado.toFixed(2); // Redondear a 2 decimales
    // Calcular el monto a devolver
    calcularMontoADevolver();
  }

  // Escuchar eventos de entrada en los campos relevantes
  totalAPagarInput.addEventListener('input', calcularMontoADevolver);
  pagoRealizadoInput.addEventListener('input', calcularMontoADevolver);

  // Escuchar cambios en los campos de entrada dentro de las modales
  modalInputs.forEach(function(input) {
    input.addEventListener('input', function() {
      // Actualizar el pago realizado
      actualizarPagoRealizado();
    });
  });
});
  </script>
        </div>
    </div>
</body>
</html>